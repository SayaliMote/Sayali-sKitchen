{% extends 'base.html' %}

{% block content %}
    <h2>Filtered Products</h2>

    <form method="GET">
        {% for type in types %}
            <h3>{{ type.name }}</h3>
            <ul>
                {% for product in products %}
                    {% if product.type == type %}
                        <li class="product-item">
                            <input type="checkbox" 
                                   name="selected_products" 
                                   value="{{ product.id }}" 
                                   {% if product.id in selected_products %}checked{% endif %}>
                            
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" width="50" height="50">

                            <a href="{% url 'shop:product_detail' type_id=product.type.id product_id=product.id %}" 
                               class="custom-link">
                                {{ product.name }} - {{ product.calories }} kcal
                            </a>

                            <!-- Add to Cart Button -->
                            <button class="add-to-cart-btn" onclick="addToCart('{{ product.id }}', event)">
                                Add to Cart
                            </button>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% endfor %}

        <h3>Total Selected Calories: <span id="totalCalories">{{ total_calories }}</span> kcal</h3>
    </form>
    <script>
        function addToCart(productId, event) {
    event.preventDefault(); // Prevent page reload

    // Example: Replace alert with actual cart functionality
    alert("Product " + productId + " added to cart!"); 

    // You can send an AJAX request to update the cart dynamically
    fetch('/cart/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken() // Ensure CSRF protection
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        alert("Cart updated!");
    })
    .catch(error => console.error('Error:', error));
}

// Function to get CSRF token (needed for POST requests in Django)
function getCSRFToken() {
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
}

    </script>
{% endblock %}
